mkdir -p /var/lib/os-apply-config/templates/var/lib/ansible/playbooks
cat << 'EOF' > /var/lib/os-apply-config/templates/var/lib/ansible/playbooks/ipfailover.yml
---
{{=<% %>=}}
- hosts: masters[0]
  sudo: yes
  tasks:
  - name: Create the ipfailover service account
    oc_serviceaccount:
      name: ipfailover
      namespace: default

  - name: Grant the ipfailover service account the appropriate scc
    oc_adm_policy_user:
      user: ipfailover
      namespace: default
      resource_kind: scc
      resource_name: privileged

  - name: Deploy Openshift IP failover for router
    command: oadm ipfailover --create --service-account=ipfailover --interface=eth0 --selector='region=infra' --replicas={{ num_infra }} --virtual-ips="{{ router_vip }}" --credentials=/etc/origin/master/openshift-router.kubeconfig
    when: ansible_first_run | default(false) | bool
    # oadm ipfailover returns error code if service account already exists even
    # if ipfailover pod is created successfully
    # remove when https://bugzilla.redhat.com/show_bug.cgi?id=1332432 is fixed
    ignore_errors: yes

- hosts: masters
  sudo: yes
  tasks:
  - name: Allow multicast for keepalived
    command: /sbin/iptables -I INPUT -i eth0 -d 224.0.0.18/32 -j ACCEPT
<%={{ }}=%>
EOF
